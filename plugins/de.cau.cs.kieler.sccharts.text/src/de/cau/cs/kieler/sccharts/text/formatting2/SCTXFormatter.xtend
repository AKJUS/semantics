/*
 * generated by Xtext
 */
package de.cau.cs.kieler.sccharts.text.formatting2;

import com.google.inject.Inject
import de.cau.cs.kieler.annotations.Annotation
import de.cau.cs.kieler.annotations.Pragma
import de.cau.cs.kieler.kexpressions.Expression
import de.cau.cs.kieler.kexpressions.Parameter
import de.cau.cs.kieler.kexpressions.keffects.Assignment
import de.cau.cs.kieler.kexpressions.keffects.Effect
import de.cau.cs.kieler.kexpressions.kext.formatting2.KExtFormatter
import de.cau.cs.kieler.sccharts.ControlflowRegion
import de.cau.cs.kieler.sccharts.DataflowRegion
import de.cau.cs.kieler.sccharts.DuringAction
import de.cau.cs.kieler.sccharts.EntryAction
import de.cau.cs.kieler.sccharts.ExitAction
import de.cau.cs.kieler.sccharts.PrecedingAction
import de.cau.cs.kieler.sccharts.Region
import de.cau.cs.kieler.sccharts.SCCharts
import de.cau.cs.kieler.sccharts.ScopeCall
import de.cau.cs.kieler.sccharts.State
import de.cau.cs.kieler.sccharts.SucceedingAction
import de.cau.cs.kieler.sccharts.SuspendAction
import de.cau.cs.kieler.sccharts.Transition
import de.cau.cs.kieler.sccharts.text.services.SCTXGrammarAccess
import org.eclipse.emf.ecore.EObject
import org.eclipse.xtext.formatting2.IFormattableDocument

class SCTXFormatter extends KExtFormatter {
	
	@Inject extension SCTXGrammarAccess

	def dispatch void format(SCCharts sccharts, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		for (Pragma pragmas : sccharts.pragmas) {
		    pragmas.append[ setNewLines(1) ]
			format(pragmas, document)
		}

		for (idxRootState : sccharts.rootStates.indexed) {
			format(idxRootState.value, document)
			if (idxRootState.key < sccharts.rootStates.size - 1) idxRootState.value.append[ newLine ]
		}
	}

	def dispatch void format(State state, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		for (Annotation annotations : state.annotations) {
			format(annotations, document)
		}
		
        format(state.reference, document);
		
        state.regionFor.keyword("{")?.prepend[ oneSpace ].append[ newLine ]
        state.regionFor.keywordPairs("{", "}").head?.interior[ indent ]
        state.regionFor.keyword("}")?.prepend[ newLine ]
		
		var EObject lastObject = null
		for (idxDeclaration : state.declarations.indexed) {
			format(idxDeclaration.value, document)
            if (idxDeclaration.key < state.declarations.size - 1) idxDeclaration.value.append[ newLine ]
			lastObject = idxDeclaration.value
		}
		
		if (lastObject != null && !state.actions.empty) lastObject.append[ newLine ]
		for (idxAction : state.actions.indexed) {
			format(idxAction.value, document);
            if (idxAction.key < state.declarations.size - 1) idxAction.value.append[ newLine ]
			lastObject = idxAction.value
		}
		
		if (!state.regions.empty) {
		    if (lastObject != null) lastObject.append[ setNewLines(2) highPriority ]
		    format(state.regions.head, document)
    		for (Region regions : state.regions.drop(1)) {
      		    switch (regions) {
       	           ControlflowRegion: regions.regionFor.keyword(controlflowRegionAccess.regionKeyword_2).prepend[ setNewLines(2) ]
       	           DataflowRegion: regions.regionFor.keyword(dataflowRegionAccess.dataflowKeyword_2).prepend[ setNewLines(2) ]
       	        }
    			format(regions, document)
    		}
        }
		
		for (Transition outgoingTransitions : state.getOutgoingTransitions()) {
		    outgoingTransitions.prepend[ newLine ]
			format(outgoingTransitions, document)
		}
	}

	def dispatch void format(ScopeCall scopecall, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		for (Parameter parameters : scopecall.getParameters()) {
			format(parameters, document);
		}
	}

	def dispatch void format(Transition transition, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		for (Annotation annotations : transition.getAnnotations()) {
			format(annotations, document);
		}
		format(transition.getTrigger(), document);
		for (Effect effects : transition.getEffects()) {
			format(effects, document);
			effects.append[ noSpace ]
		}
	}

	def dispatch void format(EntryAction entryaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(entryaction.getTrigger(), document);
		if (!entryaction.effects.empty) {
    		for (Effect effects : entryaction.getEffects().take(entryaction.effects.size - 1)) {
    			format(effects, document);
    			effects.append[ noSpace ]
    		}
		}
	}

	def dispatch void format(DuringAction duringaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(duringaction.getTrigger(), document);
        if (!duringaction.effects.empty) {
            for (Effect effects : duringaction.getEffects().take(duringaction.effects.size - 1)) {
			    format(effects, document);
			    effects.append[ noSpace ]
			}
		}
	}

	def dispatch void format(ExitAction exitaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(exitaction.getTrigger(), document);
        if (!exitaction.effects.empty) {
            for (Effect effects : exitaction.getEffects().take(exitaction.effects.size - 1)) {
			    format(effects, document);
			    effects.append[ noSpace ]
			}
		}
	}

	def dispatch void format(SuspendAction suspendaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(suspendaction.getTrigger(), document);
	}

	def dispatch void format(PrecedingAction precedingaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(precedingaction.getTrigger(), document);
        if (!precedingaction.effects.empty) {
            for (Effect effects : precedingaction.getEffects().take(precedingaction.effects.size - 1)) {
			    format(effects, document);
			    effects.append[ noSpace ]
			}
		}
	}

	def dispatch void format(SucceedingAction succeedingaction, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		format(succeedingaction.getTrigger(), document);
        if (!succeedingaction.effects.empty) {
            for (Effect effects : succeedingaction.getEffects().take(succeedingaction.effects.size - 1)) {
			    format(effects, document);
			    effects.append[ noSpace ]
			}
		}
	}

	def dispatch void format(ControlflowRegion controlflowregion, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc.
		for (Annotation annotations : controlflowregion.getAnnotations()) {
			format(annotations, document);
		}
	
		controlflowregion.regionFor.keyword(controlflowRegionAccess.colonKeyword_5).prepend[ noSpace ].append[ newLine ]
		 
        var EObject lastObject = null
        for (idxDeclaration : controlflowregion.declarations.indexed) {
            format(idxDeclaration.value, document)
            if (idxDeclaration.key < controlflowregion.declarations.size - 1) idxDeclaration.value.append[ newLine ]
            lastObject = idxDeclaration.value
        }
        
        if (lastObject != null && !controlflowregion.actions.empty) lastObject.append[ newLine ]
        for (idxAction : controlflowregion.actions.indexed) {
            format(idxAction.value, document);
            if (idxAction.key < controlflowregion.declarations.size - 1) idxAction.value.append[ newLine ]
            lastObject = idxAction.value
        }
        
		for (State states : controlflowregion.getStates()) {
		    states.prepend[ setNewLines(2) highPriority ]
			format(states, document);
		}
	}

	def dispatch void format(DataflowRegion dataflowregion, extension IFormattableDocument document) {
        // TODO: format HiddenRegions around keywords, attributes, cross references, etc.
        for (Annotation annotations : dataflowregion.getAnnotations()) {
            format(annotations, document);
        }
    
        dataflowregion.regionFor.keyword(dataflowRegionAccess.colonKeyword_5).prepend[ noSpace ].append[ newLine ]
         
        var EObject lastObject = null
        for (idxDeclaration : dataflowregion.declarations.indexed) {
            format(idxDeclaration.value, document)
            if (idxDeclaration.key < dataflowregion.declarations.size - 1) idxDeclaration.value.append[ newLine ]
            lastObject = idxDeclaration.value
        }
        
        if (lastObject != null && !dataflowregion.actions.empty) lastObject.append[ newLine ]
        for (idxAction : dataflowregion.actions.indexed) {
            format(idxAction.value, document);
            if (idxAction.key < dataflowregion.declarations.size - 1) idxAction.value.append[ newLine ]
            lastObject = idxAction.value
        }
	}

	override dispatch void format(Assignment assignment, extension IFormattableDocument document) {
		// TODO: format HiddenRegions around keywords, attributes, cross references, etc. 
		for (Annotation annotations : assignment.getAnnotations()) {
			format(annotations, document);
		}
		
        assignment.regionFor.keyword(assignmentAccess.leftSquareBracketKeyword_2_0)?.prepend[ noSpace ].append[ noSpace ]
        assignment.regionFor.keyword(assignmentAccess.rightSquareBracketKeyword_2_2)?.prepend[ noSpace ]
		
		for (Expression indices : assignment.getIndices()) {
			format(indices, document);
		}
		
		format(assignment.getExpression(), document);
	}
}
