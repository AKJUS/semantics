/*
 * generated by Xtext
 */
package de.cau.cs.kieler.yakindu.sccharts.sim.scl.scoping;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.emf.common.util.EList;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.emf.ecore.util.EcoreUtil;
import org.eclipse.xtext.EcoreUtil2;
import org.eclipse.xtext.resource.IEObjectDescription;
import org.eclipse.xtext.scoping.IScope;
import org.eclipse.xtext.scoping.Scopes;
import org.eclipse.xtext.scoping.impl.AbstractDeclarativeScopeProvider;
import org.eclipse.xtext.scoping.impl.FilteringScope;
import org.eclipse.xtext.scoping.impl.SimpleScope;
import org.yakindu.sct.model.sgraph.Declaration;
import org.yakindu.sct.model.sgraph.SGraphPackage;
import org.yakindu.sct.model.sgraph.Scope;
import org.yakindu.sct.model.sgraph.State;
import org.yakindu.sct.model.sgraph.Statechart;
import org.yakindu.sct.model.stext.scoping.STextScopeProvider;

import com.google.common.base.Predicate;
import com.google.common.collect.Iterables;
import com.google.common.collect.Lists;
import com.google.inject.Inject;

import de.cau.cs.kieler.yakindu.model.stext.utils.SyncUtils;
import de.cau.cs.kieler.yakindu.sccharts.sim.scl.scl.Assignment;
import de.cau.cs.kieler.yakindu.sccharts.sim.scl.scl.Program;
import de.cau.cs.kieler.yakindu.sccharts.sim.scl.scl.SclPackage;
import de.cau.cs.kieler.yakindu.sccharts.sim.scl.scl.VariableDeclaration;
import de.itemis.xtext.utils.jface.viewers.ContextElementAdapter;

/**
 * This class contains custom scoping description.
 * 
 * see : http://www.eclipse.org/Xtext/documentation/latest/xtext.html#scoping
 * on how and when to use it 
 *
 */
public class SCLScopeProvider extends STextScopeProvider {

    public IScope scope_Assignment_assignment(final EObject context,
            final EReference reference) {
        Assignment asm = getAssignment(context);
        
        List<EObject> scopeCandidates = Lists.newArrayList();
        ArrayList<VariableDeclaration> declarations = new ArrayList<VariableDeclaration>();
        EObject object = asm.eContainer();
        while (object != null) {
                if (object instanceof Program) {
                        EList<VariableDeclaration> vds = ((Program) object).getInterface();
                        declarations.addAll(vds);
                }
                object = object.eContainer();
        }
        if (declarations.size() > 0) {
                scopeCandidates.addAll(declarations);
                return new SimpleScope(Scopes.scopeFor(scopeCandidates).getAllElements());
        } else {
                return IScope.NULLSCOPE;
        }
        
    }
    
    protected Assignment getAssignment(EObject context) {
        final ContextElementAdapter provider = (ContextElementAdapter) EcoreUtil
                        .getExistingAdapter(context.eResource(),
                                        ContextElementAdapter.class);

        if (provider == null) {
                return EcoreUtil2.getContainerOfType(context, Assignment.class);
        } else {
                return (Assignment) EcoreUtil.getObjectByType(provider.getElement()
                                .eResource().getContents(),
                                SclPackage.Literals.ASSIGNMENT);
        }
    }
    
    
    public IScope scope_ElementReferenceExpression_reference(final EObject context,
            final EReference reference) {
        Program p = EcoreUtil2.getContainerOfType(context, Program.class);
        return null; //Scopes.scopeFor(p.getInterface());
    }  
    
}
